<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Our Story - 8 Bit Adventure</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

        body {
            background-color: #202020;
            color: white;
            font-family: 'Press Start 2P', cursive;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
            touch-action: none; /* Prevent scroll on mobile */
        }

        #game-container {
            position: relative;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            border: 4px solid #fff;
            max-width: 100%;
        }

        canvas {
            display: block;
            background-color: #000;
            max-width: 100%;
            height: auto;
            image-rendering: pixelated; /* Keeps 8-bit art crisp */
        }

        /* BUTTON LAYOUT */
        #controls {
            margin-top: 15px;
            display: flex;
            justify-content: space-between; 
            width: 100%;
            max-width: 600px;
            padding: 0 10px;
            box-sizing: border-box;
            align-items: flex-end;
        }

        /* D-Pad Style */
        .left-controls { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            gap: 5px; 
            align-items: center; 
            justify-items: center;
        }
        .right-controls { display: flex; flex-direction: column; gap: 10px; align-items: center; }

        .btn {
            background-color: #7f8c8d; 
            border: 4px solid #34495e;
            border-radius: 8px;
            cursor: pointer;
            color: #ddd;
            font-family: inherit;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            touch-action: manipulation;
            width: 70px;
            height: 70px;
        }
        .btn:active, .btn.active { background-color: #95a5a6; transform: translateY(2px); }

        /* D-Pad Positioning */
        #btn-up { grid-column: 2; grid-row: 1; }
        #btn-left { grid-column: 1; grid-row: 2; }
        #btn-right { grid-column: 3; grid-row: 2; }

        .action-btn {
            width: 110px;
            height: 50px;
            border-radius: 12px;
            font-size: 14px;
            color: white;
            border-width: 4px;
            border-style: solid;
        }

        #btn-jump { background-color: #2980b9; border-color: #1a5276; margin-bottom: 5px; }
        #btn-jump:active, #btn-jump.active { background-color: #3498db; }

        #btn-enter { background-color: #27ae60; border-color: #1e8449; }
        #btn-enter:active, #btn-enter.active { background-color: #2ecc71; }

        #btn-restart {
            position: absolute;
            left: 10px;
            bottom: 10px;
            width: 30px;
            height: 30px;
            font-size: 16px;
            background-color: #c0392b; 
            border: 2px solid #922b21;
            border-radius: 5px;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: inherit;
            touch-action: manipulation;
        }

        .hint {
            margin-top: 10px;
            font-size: 10px;
            color: #888;
            text-align: center;
        }
    </style>
</head>
<body>

    <div id="game-container">
        <canvas id="gameCanvas" width="600" height="400"></canvas>
    </div>

    <div id="controls">
        <div class="left-controls">
            <button class="btn" id="btn-up">▲</button>
            <button class="btn" id="btn-left">◀</button>
            <button class="btn" id="btn-right">▶</button>
        </div>
        
        <div class="right-controls">
            <button class="btn action-btn" id="btn-jump">JUMP</button>
            <button class="btn action-btn" id="btn-enter">ENTER</button>
        </div>
    </div>
    <button id="btn-restart" title="Restart Game">↻</button>
    
    <div class="hint">Arrows to Move | Blue to Jump | Green to Select</div>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');

    // === GAME STATE ===
    const STATES = {
        START: 0,
        TINDER: 1,
        MATCHED: 2,
        DATING_TACOS: 3,
        DATING_PUB: 10,       
        DATING_YELLOW: 11,    
        DATING_KROGER: 13,    
        DATING_IFLY: 4,
        DATING_ODDWORLD: 12,  
        TRAVEL_MAP: 5,
        PREGNANCY_TEST: 6,
        CHRISTMAS: 7,
        BIRTH: 8,
        PARENTING_CHAOS: 20,
        JEWELRY_STORE: 27, 
        HALLOWEEN: 21,
        MAKING_MONTAGE: 28,
        THANKSGIVING: 22,
        THEATER_OUTSIDE: 23,
        THEATER_INSIDE: 24, 
        FUTURE_HOME: 25,
        FINAL_HINT: 26
    };
    
    let currentState = STATES.START;
    let frame = 0;
    let lastTime = 0;

    // === VARIABLES ===
    let tinderIndex = 0; 
    let tinderSwipeAnim = 0;
    
    // Proposal Logic
    let proposalChoice = 1; 
    let screenShake = 0;
    let celebrationActive = false;
    let celebrationTimer = 0;
    let balloons = [];
    let confetti = [];

    // Jewelry Store Logic
    let ringIndex = 0; 
    let jewelryState = "browsing"; 

    // Physics
    let jumpY = 0;
    let jumpVel = 0;
    const GRAVITY = 0.8;
    const JUMP_STRENGTH = -18; // Higher jump to clear obstacles
    let obstacles = [];
    let oddworldX = 50; 
    let sceneCharX = 100; 

    const tinderProfiles = [
        { name: "SADIE", hair: "#f1c40f", top: "#e74c3c", skin: "#ffdbac" }, 
        { name: "AMBER", hair: "#d35400", top: "#3498db", skin: "#e0ac69" }, 
        { name: "JESSICA", hair: "#555555", top: "#2ecc71", skin: "#8d5524" }
    ];

    // CITIES LIST 
    const cities = [
        { name: "Cincinnati", type: "swing" },
        { name: "Cleveland", type: "icecream" },
        { name: "Savannah", type: "pinkhouse" },
        { name: "Nashville", type: "neon" },
        { name: "Baton Rouge", type: "swamp" },
        { name: "New Orleans", type: "bourbon" },
        { name: "Traverse City", type: "dunes" },
        { name: "Indianapolis", type: "bottleworks" }
    ];
    
    let cityIndex = 0;
    let travelProgress = 0; 
    let testAttempts = 0;
    let testResultState = "waiting"; 
    let christmasSparkle = [];

    const palette = {
        bg: "#202020",
        maleSkin: "#eec39a", maleHair: "#5a4a3a", maleBeard: "#3e3223", maleShirtColor: "#1a1a1a", malePantsColor: "#d2b48c",
        femSkin: "#d2a679", femHair: "#1a1a1a", femTop: "#9b59b6", femAcc: "#f1c40f",
        babySkin: "#f5d0a9", babyHat: "#ffffff", babyPaci: "#f1c40f",
        taco: "#f39c12", sky: "#87CEEB", road: "#555555", heart: "#e74c3c", wood: "#8e44ad", signWood: "#a0522d", signBorder: "#603015", grass: "#2ecc71",
        sand: "#f4d03f", swampWater: "#1e8449", neonBlue: "#00ffff", neonPink: "#ff00ff", pinkHouse: "#ffc0cb", brick: "#a93226",
        krogerBlue: "#0066B6", krogerBrick: "#6d4c41",
        pubBlack: "#1a1a1a", pubDoorRed: "#d90429", pubGold: "#f1c40f", pubOrange: "#e67e22", pubStraw: "#e5c376",
        halloweenOrange: "#e67e22", theaterRed: "#c0392b", cowboyHat: "#8d6e63"
    };

    for(let i=0; i<50; i++) christmasSparkle.push({x: Math.random()*600, y: Math.random()*400, speed: Math.random()*2+1, color: Math.random()>0.5?"gold":"white"});

    let keys = {};
    window.addEventListener('keydown', (e) => { keys[e.key] = true; processSingleInput(e.key); });
    window.addEventListener('keyup', (e) => keys[e.key] = false);

    const setupTouchButton = (id, key) => {
        const btn = document.getElementById(id);
        const press = (e) => { if(e.cancelable) e.preventDefault(); keys[key] = true; btn.classList.add('active'); processSingleInput(key); };
        const release = (e) => { if(e.cancelable) e.preventDefault(); keys[key] = false; btn.classList.remove('active'); };
        btn.addEventListener('touchstart', press); btn.addEventListener('touchend', release);
        btn.addEventListener('mousedown', press); btn.addEventListener('mouseup', release); btn.addEventListener('mouseleave', release);
    };
    setupTouchButton('btn-right', 'ArrowRight'); 
    setupTouchButton('btn-left', 'ArrowLeft'); 
    setupTouchButton('btn-jump', 'ArrowUp'); 
    setupTouchButton('btn-up', 'ArrowUp'); // Add up arrow listener
    setupTouchButton('btn-enter', 'Enter');
    
    document.getElementById('btn-restart').addEventListener('click', () => {
        currentState = STATES.START; tinderIndex=0; tinderSwipeAnim=0; cityIndex=0; travelProgress=0; testAttempts=0; testResultState="waiting";
        proposalChoice=1; screenShake=0; celebrationActive=false; celebrationTimer=0; balloons=[]; confetti=[]; obstacles=[]; ringIndex=0; jewelryState="browsing"; oddworldX=50; sceneCharX=100; keys={};
    });

    function resetScene() {
        sceneCharX = 100;
        jumpY = 0;
        obstacles = [];
        if (currentState === STATES.TRAVEL_MAP) travelProgress = 0;
    }

    function processSingleInput(key) {
        if (key === "ArrowUp") {
            if (jumpY === 0) jumpVel = JUMP_STRENGTH;
        }
        if (currentState === STATES.START) { if (key==="Enter"||key==="ArrowRight"||key===" ") currentState = STATES.TINDER; }
        else if (currentState === STATES.TINDER && tinderSwipeAnim === 0) {
            if (key==="ArrowLeft") { 
                // Left Swipes No/Next (REJECT)
                tinderSwipeAnim=-10; 
                setTimeout(() => { 
                    if(tinderIndex<3) tinderIndex++; 
                    tinderSwipeAnim=0; 
                }, 300); 
            }
            else if (key==="ArrowRight") { 
                // Right Swipes Yes
                if (tinderIndex < 3) {
                    // If not Veronica, don't match, just shake
                    screenShake = 20;
                } else {
                    // If Veronica
                    tinderSwipeAnim=10; 
                    setTimeout(() => {
                        currentState=STATES.MATCHED; 
                    }, 300); 
                }
            }
        }
        else if (currentState === STATES.MATCHED) { if (key==="ArrowLeft") {currentState=STATES.TINDER; tinderIndex=3;} else if (key==="ArrowRight"||key==="Enter") currentState=STATES.DATING_TACOS; }
        else if (currentState === STATES.DATING_TACOS) { if (key==="ArrowLeft") currentState=STATES.MATCHED; else if (key==="ArrowRight") { currentState=STATES.DATING_PUB; resetScene(); } }
        else if (currentState === STATES.DATING_PUB) { if (key==="ArrowLeft") currentState=STATES.DATING_TACOS; else if (key==="ArrowRight" && sceneCharX > 550) { currentState=STATES.DATING_YELLOW; resetScene(); } }
        else if (currentState === STATES.DATING_YELLOW) { if (key==="ArrowLeft") currentState=STATES.DATING_PUB; else if (key==="ArrowRight" && sceneCharX > 550) { currentState=STATES.DATING_KROGER; resetScene(); } }
        else if (currentState === STATES.DATING_KROGER) {
            if (!celebrationActive) {
                if (key==="ArrowLeft"||key==="ArrowRight") proposalChoice = proposalChoice===1?0:1;
                if (key==="Enter"||key===" ") { if(proposalChoice===1) startCelebration(); else screenShake=20; }
            }
        }
        else if (currentState === STATES.DATING_IFLY) { if (key==="ArrowLeft") currentState=STATES.DATING_KROGER; else if (key==="ArrowRight") { currentState=STATES.DATING_ODDWORLD; oddworldX=50; } }
        else if (currentState === STATES.DATING_ODDWORLD) { if (key==="ArrowLeft" && oddworldX<=50) currentState=STATES.DATING_IFLY; }
        else if (currentState === STATES.TRAVEL_MAP) {
            if (keys["ArrowLeft"]) { travelProgress-=1; if(travelProgress<0 && cityIndex>0){cityIndex--; travelProgress=149;} else if (travelProgress<0 && cityIndex===0) { currentState=STATES.DATING_ODDWORLD; oddworldX=550; } }
        }
        else if (currentState === STATES.PREGNANCY_TEST) {
            if (key==="ArrowLeft") { currentState=STATES.TRAVEL_MAP; cityIndex=cities.length-1; travelProgress=149; }
            else if ((key==="Enter"||key===" ") && testResultState==="waiting") {
                testAttempts++; testResultState="checking";
                setTimeout(() => { if (testAttempts<4) {testResultState="negative"; setTimeout(()=>testResultState="waiting",500);} else {testResultState="positive"; setTimeout(()=>currentState=STATES.CHRISTMAS,3000);} }, 500);
            }
        }
        else if (currentState === STATES.CHRISTMAS) { if (key==="ArrowLeft") currentState=STATES.PREGNANCY_TEST; else if (key==="ArrowRight") { currentState=STATES.BIRTH; resetScene(); } }
        else if (currentState === STATES.BIRTH) { if (key==="ArrowLeft") currentState=STATES.CHRISTMAS; if (key==="ArrowRight") { currentState=STATES.PARENTING_CHAOS; resetScene(); } }
        else if (currentState === STATES.PARENTING_CHAOS) { if (key==="ArrowLeft") currentState=STATES.BIRTH; }
        else if (currentState === STATES.JEWELRY_STORE) {
            if (jewelryState==="browsing") {
                if(key==="ArrowRight") ringIndex=(ringIndex+1)%3; if(key==="ArrowLeft") ringIndex=(ringIndex+2)%3;
                if(key==="Enter") { if(ringIndex===2) { currentState=STATES.HALLOWEEN; resetScene(); } else { jewelryState="rejected"; setTimeout(()=>jewelryState="browsing",1000); } }
            }
        }
        else if (currentState === STATES.MAKING_MONTAGE) { if (key==="ArrowRight") { currentState=STATES.THANKSGIVING; resetScene(); } }
        else if (currentState === STATES.THANKSGIVING) { if (key==="ArrowLeft") currentState=STATES.MAKING_MONTAGE; } 
        else if (currentState === STATES.THEATER_OUTSIDE) { if (key==="ArrowLeft") currentState=STATES.THANKSGIVING; if (key==="ArrowRight") { currentState=STATES.THEATER_INSIDE; proposalChoice=1; } }
        else if (currentState === STATES.THEATER_INSIDE) {
            if (!celebrationActive) {
                if (key==="ArrowLeft"||key==="ArrowRight") proposalChoice=proposalChoice===1?0:1;
                if (key==="Enter"||key===" ") { if(proposalChoice===1) startCelebration(); else screenShake=20; }
            }
        }
        else if (currentState === STATES.FUTURE_HOME) { if (key==="ArrowRight"||key==="Enter"||key===" ") currentState=STATES.FINAL_HINT; }
        else if (currentState === STATES.FINAL_HINT) { if (key==="ArrowLeft") currentState=STATES.FUTURE_HOME; }
    }

    function startCelebration() { celebrationActive=true; celebrationTimer=0; balloons=[]; confetti=[]; for(let i=0;i<20;i++) balloons.push({x:50+Math.random()*500, y:400+Math.random()*200, speed:2+Math.random()*2, color:`hsl(${Math.random()*360},70%,60%)`}); for(let i=0;i<100;i++) confetti.push({x:Math.random()*600, y:-10-Math.random()*400, speed:2+Math.random()*3, color:`hsl(${Math.random()*360},90%,50%)`}); }

    function spawnObstacle(type) { 
        obstacles.push({x:650, y:310, width:30, height:30, type:type, active:true}); 
    }

    function drawObstacle(obs) {
        if (obs.type === "icecream") {
            ctx.fillStyle = "#d35400"; ctx.beginPath(); ctx.moveTo(obs.x, obs.y+20); ctx.lineTo(obs.x+30, obs.y+20); ctx.lineTo(obs.x+15, obs.y+50); ctx.fill();
            ctx.fillStyle = "pink"; ctx.beginPath(); ctx.arc(obs.x+15, obs.y+20, 15, 0, Math.PI, true); ctx.fill();
        } else if (obs.type === "gator") {
            ctx.fillStyle = "#2ecc71"; ctx.fillRect(obs.x, obs.y+15, 40, 15); ctx.fillStyle = "yellow"; ctx.fillRect(obs.x+5, obs.y+10, 5, 5);
        } else if (obs.type === "poop") {
            ctx.fillStyle = "#795548"; ctx.beginPath(); ctx.arc(obs.x+15, obs.y+20, 15, 0, Math.PI*2); ctx.fill();
            ctx.fillStyle = "white"; ctx.fillRect(obs.x+5, obs.y+15, 5, 5); ctx.fillRect(obs.x+20, obs.y+15, 5, 5);
        } else if (obs.type === "pumpkin") {
            ctx.fillStyle = "#e67e22"; ctx.beginPath(); ctx.arc(obs.x+15, obs.y+15, 15, 0, Math.PI*2); ctx.fill(); ctx.fillStyle = "green"; ctx.fillRect(obs.x+12, obs.y-5, 6, 6);
        } else if (obs.type === "turkey") {
             ctx.fillStyle = "#8d6e63"; ctx.beginPath(); ctx.arc(obs.x+15, obs.y+15, 20, Math.PI, 0, false); ctx.fill(); // Tail fan
             ctx.fillStyle = "#8d6e63"; ctx.beginPath(); ctx.arc(obs.x+15, obs.y+20, 12, 0, Math.PI*2); ctx.fill(); // Body
             ctx.fillStyle = "#a93226"; ctx.fillRect(obs.x+12, obs.y+10, 4, 8); // Neck
        }
    }

    function drawMale(x, y, scale=1, kneeling=false, sideProfile=false) {
        ctx.save(); ctx.translate(x, y); ctx.scale(scale, scale);
        let yOffset = kneeling ? 15 : 0;
        ctx.fillStyle = palette.maleShirtColor; 
        if(sideProfile) { ctx.fillRect(-10, 20, 20, 25); } 
        else { ctx.fillRect(-15, 20+yOffset, 30, 25); ctx.fillRect(-18, 20+yOffset, 3, 10); ctx.fillRect(15, 20+yOffset, 3, 10); }
        ctx.fillStyle = palette.maleSkin; 
        if(!sideProfile) { ctx.fillRect(-18, 30+yOffset, 3, 15); ctx.fillRect(15, 30+yOffset, 3, 15); }
        else { ctx.fillRect(5, 25, 15, 5); } 

        ctx.fillStyle = palette.malePantsColor;
        if (kneeling) { ctx.fillRect(-15, 45+yOffset, 30, 10); ctx.fillRect(15, 50+yOffset, 10, 5); } 
        else if(sideProfile) { ctx.fillRect(-10, 45, 20, 15); ctx.fillRect(10, 50, 10, 15); } 
        else { ctx.fillRect(-15, 45, 30, 15); }

        ctx.fillStyle = palette.maleSkin; ctx.fillRect(-12, -10+yOffset, 24, 30);
        ctx.fillStyle = palette.maleBeard; ctx.fillRect(-12, 10+yOffset, 24, 10); 
        if(!sideProfile) { ctx.fillRect(-12, 5+yOffset, 4, 10); ctx.fillRect(8, 5+yOffset, 4, 10); ctx.fillRect(-5, 12+yOffset, 10, 5); ctx.fillRect(-5, 5+yOffset, 10, 2); }
        else { ctx.fillRect(8, 5, 4, 10); } 
        
        ctx.fillStyle = palette.maleHair; ctx.fillRect(-14, -15+yOffset, 28, 10); 
        if(!sideProfile) { ctx.fillRect(-14, -5+yOffset, 4, 10); ctx.fillRect(10, -5+yOffset, 4, 10); }
        
        ctx.fillStyle = "#000"; 
        if(sideProfile) ctx.fillRect(8, 0, 4, 4);
        else { ctx.fillRect(-8, 0+yOffset, 4, 4); ctx.fillRect(4, 0+yOffset, 4, 4); }
        ctx.restore();
    }

    function drawFemale(x, y, scale=1, colors = {}) {
        const top = colors.top || palette.femTop; const skin = colors.skin || palette.femSkin; const hair = colors.hair || palette.femHair; const acc = colors.acc || palette.femAcc;
        ctx.save(); ctx.translate(x, y); ctx.scale(scale, scale);
        ctx.fillStyle = top; ctx.fillRect(-15, 20, 30, 40); ctx.fillStyle = skin; ctx.fillRect(-20, 20, 5, 30); ctx.fillRect(15, 20, 5, 30); ctx.fillStyle = skin; ctx.fillRect(-12, -10, 24, 30); ctx.fillStyle = "#000"; ctx.fillRect(-8, 0, 4, 4); ctx.fillRect(4, 0, 4, 4); ctx.fillStyle = "#a34a4a"; ctx.fillRect(-6, 12, 12, 3); ctx.fillStyle = "#fff"; ctx.fillRect(-4, 13, 8, 1); ctx.fillStyle = hair; ctx.fillRect(-14, -15, 28, 12); ctx.fillRect(-16, -5, 6, 45); ctx.fillRect(10, -5, 6, 45); ctx.fillStyle = acc; ctx.fillRect(-16, 10, 3, 6); ctx.fillRect(13, 10, 3, 6); 
        ctx.restore();
    }

    function drawBaby(x, y, scale=1, costume=null, angry=false) {
        ctx.save(); ctx.translate(x, y); ctx.scale(scale, scale);
        ctx.fillStyle = "#ffffff"; ctx.fillRect(-15, 5, 30, 25); 
        if (costume === "cowboy") { ctx.fillStyle = "#8d6e63"; ctx.fillRect(-15, 5, 30, 25); ctx.fillStyle = "#f1c40f"; ctx.fillRect(-5, 10, 10, 10); }
        ctx.fillStyle = palette.babySkin; ctx.fillRect(-10, -10, 20, 15);
        if (costume === "cowboy") { ctx.fillStyle = palette.cowboyHat; ctx.fillRect(-20, -15, 40, 5); ctx.fillRect(-12, -25, 24, 10); } else { ctx.fillStyle = palette.babyHat; ctx.fillRect(-11, -15, 22, 6); ctx.fillRect(-9, -20, 18, 5); ctx.fillRect(-3, -24, 6, 4); }
        if (angry) { ctx.fillStyle = "red"; ctx.fillRect(-7, -4, 4, 2); ctx.fillRect(3, -4, 4, 2); } else { ctx.fillStyle = "#000"; ctx.fillRect(-7, -4, 3, 1); ctx.fillRect(4, -4, 3, 1); }
        ctx.fillStyle = palette.babyPaci; ctx.fillRect(-3, 0, 6, 4);
        ctx.restore();
    }

    function drawSpeechBubble(text, x, y) {
        ctx.fillStyle = "white"; ctx.strokeStyle = "black"; ctx.lineWidth = 2;
        let width = text.length * 10 + 20;
        ctx.globalCompositeOperation = "source-over"; 
        ctx.fillRect(x - width/2, y - 40, width, 30); ctx.strokeRect(x - width/2, y - 40, width, 30);
        ctx.beginPath(); ctx.moveTo(x, y-10); ctx.lineTo(x-10, y); ctx.lineTo(x+10, y-10); ctx.fill(); ctx.stroke();
        ctx.fillStyle = "black"; ctx.font = "10px monospace"; ctx.textAlign = "center"; ctx.fillText(text, x, y - 22);
    }

    function drawPixelHeart(x, y, size) { ctx.fillStyle = palette.heart; ctx.save(); ctx.translate(x, y); ctx.scale(size, size); ctx.beginPath(); ctx.fillRect(-1, -1, 1, 1); ctx.fillRect(1, -1, 1, 1); ctx.fillRect(-2, 0, 5, 2); ctx.fillRect(-1, 2, 3, 1); ctx.fillRect(0, 3, 1, 1); ctx.restore(); }
    function drawText(text, x, y, size, align="center", color="white") { ctx.font = `${size}px 'Press Start 2P'`; ctx.textAlign = align; ctx.fillStyle = "rgba(0,0,0,0.8)"; ctx.fillText(text, x+2, y+2); ctx.fillStyle = color; ctx.fillText(text, x, y); }
    function drawWelcomeSign(x, y, cityName) {
        ctx.fillStyle = palette.signBorder; ctx.fillRect(x-5, y-105, 10, 250); // Pole connected
        ctx.fillStyle = palette.signBorder; ctx.fillRect(x-105, y-105, 210, 70); 
        ctx.fillStyle = palette.signWood; ctx.fillRect(x-100, y-100, 200, 60);
        drawText("WELCOME TO", x, y-80, 12, "center", "#3e2723");
        drawText(cityName.toUpperCase(), x, y-55, 12, "center", "#3e2723");
    }

    // === MAIN LOOP ===
    function gameLoop(timestamp) {
        const dt = timestamp - lastTime; lastTime = timestamp; frame++;
        ctx.fillStyle = palette.bg; ctx.fillRect(0, 0, canvas.width, canvas.height);

        // Physics
        jumpY += jumpVel; if (jumpY < 0) jumpVel += GRAVITY; else { jumpY = 0; jumpVel = 0; }
        if (screenShake > 0) { ctx.save(); ctx.translate(Math.random()*10-5, Math.random()*10-5); screenShake--; }

        // GLOBAL SCENE MOVEMENT (For specific scenes)
        if (
            currentState === STATES.DATING_PUB || currentState === STATES.DATING_YELLOW || 
            currentState === STATES.DATING_KROGER || currentState === STATES.PARENTING_CHAOS ||
            currentState === STATES.HALLOWEEN || currentState === STATES.THANKSGIVING || 
            (currentState === STATES.TRAVEL_MAP && (cities[cityIndex].type==="pinkhouse" || cities[cityIndex].type==="neon" || cities[cityIndex].type==="bourbon" || cities[cityIndex].type==="bottleworks")) // Fix for Savannah, Nashville, New Orleans, and Indianapolis
        ) {
            if (keys["ArrowRight"]) sceneCharX += 3;
            if (keys["ArrowLeft"]) sceneCharX -= 3;
        }

        // SCENE TRANSITION CHECK
        if(currentState === STATES.DATING_PUB && sceneCharX > 550) { currentState=STATES.DATING_YELLOW; resetScene(); }
        if(currentState === STATES.DATING_YELLOW && sceneCharX > 550) { currentState=STATES.DATING_KROGER; resetScene(); }
        if(currentState === STATES.PARENTING_CHAOS && sceneCharX > 550) { currentState=STATES.JEWELRY_STORE; resetScene(); }
        if(currentState === STATES.HALLOWEEN && sceneCharX > 550) { currentState=STATES.MAKING_MONTAGE; resetScene(); }
        if(currentState === STATES.THANKSGIVING && sceneCharX > 550) { currentState=STATES.THEATER_OUTSIDE; resetScene(); }


        // OBSTACLE LOGIC
        if (
            (currentState === STATES.TRAVEL_MAP && (cities[cityIndex].type==="icecream" || cities[cityIndex].type==="swamp")) ||
            currentState === STATES.PARENTING_CHAOS || currentState === STATES.HALLOWEEN || currentState === STATES.THANKSGIVING
        ) {
            // Spawn
            if (frame % 100 === 0) {
                let type = "";
                if(currentState===STATES.PARENTING_CHAOS) type="poop";
                else if(currentState===STATES.HALLOWEEN) type="pumpkin";
                else if(currentState===STATES.THANKSGIVING) type="turkey";
                else if(cities[cityIndex].type==="icecream") type="icecream";
                else if(cities[cityIndex].type==="swamp") type="gator";
                if(type) spawnObstacle(type);
            }
            for(let i=obstacles.length-1; i>=0; i--) {
                obstacles[i].x -= 4;
                let charX = 200; 
                if(currentState===STATES.TRAVEL_MAP) charX = 50 + (travelProgress/200)*500; 
                else if(currentState===STATES.PARENTING_CHAOS || currentState===STATES.HALLOWEEN || currentState===STATES.THANKSGIVING) charX = sceneCharX;

                let obs = obstacles[i];
                if(obs.active && obs.x < charX+30 && obs.x+30 > charX && obs.y < 280+jumpY+40 && obs.y+30 > 280+jumpY) {
                     screenShake = 10; obs.active = false;
                }
                if(obs.x < -50) obstacles.splice(i, 1);
            }
        } else { obstacles = []; }

        // Travel Movement
        if (currentState === STATES.TRAVEL_MAP) {
            if (keys["ArrowRight"]) { travelProgress+=1; if(travelProgress>=200){travelProgress=0; cityIndex++; resetScene(); if(cityIndex>=cities.length) currentState=STATES.PREGNANCY_TEST;} }
            if (keys["ArrowLeft"]) { travelProgress-=1; if(travelProgress<0){ if(cityIndex>0){cityIndex--; travelProgress=149; resetScene();} else {currentState=STATES.DATING_ODDWORLD; oddworldX=550;} } }
        }
        if (currentState === STATES.DATING_ODDWORLD) {
            if (keys["ArrowRight"]) oddworldX += 3;
            if (keys["ArrowLeft"]) oddworldX -= 3;
            if (oddworldX > 480 && jumpY < -5) { currentState=STATES.TRAVEL_MAP; travelProgress=0; resetScene(); } // Pipe
        }
        
        // === RENDER ===
        switch(currentState) {
            case STATES.START:
                drawText("THE DELBECKERS", 300, 120, 35, "center", "#fff");
                drawText("DIGITAL ADVENTURE", 300, 160, 15, "center", "#aaa");
                drawMale(220, 250, 3); drawFemale(380, 250, 3);
                if (frame % 60 < 30) drawText("PRESS ENTER ( > )", 300, 350, 20, "center", "#f1c40f");
                break;
            case STATES.TINDER:
                drawText("SWIPE TO FIND LOVE", 300, 50, 20, "center");
                ctx.strokeStyle="#fff"; ctx.lineWidth=4; ctx.strokeRect(200, 80, 200, 280);
                let cardX=300+tinderSwipeAnim*20;
                ctx.fillStyle="#fff"; ctx.fillRect(cardX-80, 100, 160, 200);
                if(tinderIndex<3) { ctx.fillStyle="#bdc3c7"; ctx.fillRect(cardX-60, 120, 120, 120); drawFemale(cardX, 160, 2, {hair:tinderProfiles[tinderIndex].hair, top:tinderProfiles[tinderIndex].top, skin:tinderProfiles[tinderIndex].skin}); drawText(tinderProfiles[tinderIndex].name, cardX, 330, 15, "center", "#f1c40f"); }
                else { ctx.fillStyle="#e8daef"; ctx.fillRect(cardX-60, 120, 120, 120); drawFemale(cardX, 160, 2); drawText("VERONICA", cardX, 330, 15, "center", "#f1c40f"); }
                if(tinderIndex===3 && frame%30<15) drawText("SWIPE RIGHT! >", 500, 200, 12, "center", palette.heart);
                break;
            case STATES.MATCHED:
                drawText("IT'S A MATCH!", 300, 100, 40, "center", "#e91e63");
                drawMale(220, 250, 3); drawFemale(380, 250, 3); drawPixelHeart(300, 200, 5);
                break;
            case STATES.DATING_TACOS:
                ctx.fillStyle="#2c3e50"; ctx.fillRect(0,0,600,400); drawText("CONDADOS TACOS", 300, 60, 25, "center", "#f1c40f");
                ctx.fillStyle=palette.wood; ctx.fillRect(200, 300, 200, 100); drawMale(180, 280, 2.5); drawFemale(420, 280, 2.5);
                ctx.fillStyle=palette.taco; ctx.beginPath(); ctx.arc(260, 290, 15, Math.PI, 0); ctx.fill(); ctx.beginPath(); ctx.arc(340, 290, 15, Math.PI, 0); ctx.fill();
                drawText("First Date Success!", 300, 380, 15, "center");
                break;
            case STATES.DATING_PUB:
                ctx.fillStyle="#7f8c8d"; ctx.fillRect(0,0,600,400); ctx.fillStyle=palette.pubBlack; ctx.fillRect(50, 50, 500, 350);
                drawText("The Pub", 300, 120, 40, "center", palette.pubGold);
                ctx.fillStyle=palette.pubDoorRed; ctx.fillRect(220, 200, 75, 150); ctx.fillRect(305, 200, 75, 150);
                ctx.strokeStyle="#1a1a1a"; ctx.lineWidth=2; ctx.strokeRect(220, 200, 75, 150); ctx.strokeRect(305, 200, 75, 150);
                ctx.fillStyle=palette.pubStraw; ctx.fillRect(150, 300, 40, 50); ctx.fillRect(410, 300, 40, 50);
                ctx.fillStyle=palette.pubOrange; ctx.beginPath(); ctx.arc(170, 340, 15, 0, Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(430, 340, 15, 0, Math.PI*2); ctx.fill();
                drawMale(sceneCharX, 310, 2.5); drawFemale(sceneCharX+40, 310, 2.5); drawText("Second Date Success!", 300, 380, 15, "center");
                break;
            case STATES.DATING_YELLOW:
                ctx.fillStyle="#87ceeb"; ctx.fillRect(0,0,600,400); ctx.fillStyle="#7cb342"; ctx.beginPath(); ctx.arc(300, 500, 300, 0, Math.PI*2); ctx.fill();
                drawText("YELLOW SPRINGS, OH", 300, 60, 25, "center", "#1b5e20");
                ctx.fillStyle="#5d4037"; ctx.fillRect(100, 200, 20, 100); ctx.fillRect(500, 220, 20, 80);
                ctx.fillStyle="#2e7d32"; ctx.beginPath(); ctx.arc(110, 180, 40, 0, Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(510, 200, 35, 0, Math.PI*2); ctx.fill();
                drawMale(sceneCharX, 250+jumpY, 2); drawFemale(sceneCharX+40, 250+jumpY, 2);
                drawText("Third Date Success!", 300, 380, 15, "center");
                drawSpeechBubble("I want to be a circus clown.", sceneCharX-10, 180); drawSpeechBubble("...no.", sceneCharX+50, 230);
                break;
            case STATES.DATING_KROGER:
                ctx.fillStyle="#87CEEB"; ctx.fillRect(0,0,600,400); ctx.fillStyle="#7f8c8d"; ctx.fillRect(0, 320, 600, 80);
                ctx.fillStyle=palette.krogerBrick; ctx.fillRect(20, 50, 560, 270);
                ctx.fillStyle="#cfd8dc"; ctx.fillRect(220, 180, 160, 140); ctx.fillStyle="#81d4fa"; ctx.fillRect(230, 190, 60, 130); ctx.fillRect(310, 190, 60, 130);
                ctx.fillStyle="#ecf0f1"; ctx.fillRect(180, 80, 240, 60); drawText("Kroger", 300, 125, 30, "center", palette.krogerBlue);
                drawMale(sceneCharX, 330, 2.5); drawFemale(sceneCharX+40, 330, 2.5);
                if (!celebrationActive) {
                    ctx.fillStyle="white"; ctx.strokeStyle="black"; ctx.lineWidth=4; ctx.strokeRect(100, 20, 400, 70); ctx.fillRect(100, 20, 400, 70);
                    drawText("Will you be my girlfriend?", 300, 50, 12, "center", "black"); drawText("(Select Yes or No)", 300, 75, 10, "center", "#7f8c8d");
                    drawText("YES", 250, 350, 20, "center", proposalChoice===1?palette.krogerBlue:"#bdc3c7");
                    drawText("NO", 350, 350, 20, "center", proposalChoice===0?palette.krogerBlue:"#bdc3c7");
                    drawText(">", proposalChoice===1?200:390, 350, 20, "center", palette.krogerBlue);
                } else {
                    celebrationTimer++;
                    confetti.forEach(c => { ctx.fillStyle = c.color; ctx.fillRect(c.x, c.y, 4, 4); c.y += c.speed; c.x += Math.sin(frame/10 + c.speed)*2; });
                    balloons.forEach(b => { ctx.fillStyle = b.color; ctx.beginPath(); ctx.arc(b.x, b.y, 10, 0, Math.PI*2); ctx.fill(); b.y -= b.speed; });
                    drawText("SHE SAID YES!", 300, 200, 40, "center", "#e91e63");
                    if (celebrationTimer > 200) { currentState = STATES.DATING_IFLY; celebrationActive = false; celebrationTimer = 0; }
                }
                break;
            case STATES.DATING_IFLY:
                ctx.fillStyle=palette.sky; ctx.fillRect(0,0,600,400); drawText("iFLY ADVENTURE", 300, 60, 25, "center", "#2980b9");
                let floatY=Math.sin(frame/20)*20; drawMale(250, 200+floatY, 2); drawFemale(350, 200-floatY, 2);
                break;
            case STATES.DATING_ODDWORLD:
                let r=Math.sin(frame/20)*50+50; let g=Math.cos(frame/30)*50+50; let b=Math.sin(frame/40)*50+100;
                ctx.fillStyle=`rgb(${r},${g},${b})`; ctx.fillRect(0,0,600,400);
                ctx.fillStyle="rgba(255,255,255,0.2)"; for(let i=0; i<5; i++) { ctx.beginPath(); ctx.arc(100+i*100, 200+Math.sin((frame+i*50)/20)*50, 30, 0, Math.PI*2); ctx.fill(); }
                drawWelcomeSign(300, 200, "COLUMBUS"); drawText("ODDWORLD", 300, 350, 15, "center", "#fff");
                // Pipe
                ctx.fillStyle="#27ae60"; ctx.fillRect(500, 300, 80, 100); ctx.fillRect(490, 300, 100, 30);
                drawMale(oddworldX, 280+jumpY, 2); drawFemale(oddworldX+20, 280+jumpY, 2);
                break;
            case STATES.TRAVEL_MAP:
                let currentCity = cities[cityIndex];
                // Draw BG First
                if(currentCity.type==="swing") { ctx.fillStyle="#e59866"; ctx.fillRect(0,0,600,400); }
                else if(currentCity.type==="icecream" || currentCity.type==="dunes") { ctx.fillStyle="#85c1e9"; ctx.fillRect(0,0,600,400); }
                else if(currentCity.type==="bottleworks" || currentCity.type==="neon" || currentCity.type==="bourbon") { ctx.fillStyle="#050505"; ctx.fillRect(0,0,600,400); }
                else if(currentCity.type==="pinkhouse") { ctx.fillStyle="#85929e"; ctx.fillRect(0,0,600,400); }
                else if(currentCity.type==="swamp") { ctx.fillStyle="#87CEEB"; ctx.fillRect(0,0,600,400); }
                else { ctx.fillStyle="#34495e"; ctx.fillRect(0,0,600,400); }
                
                // Draw Scene Details & Obstacles (Obstacles must be AFTER BG)
                if(currentCity.type==="swing") {
                    let swingX = 300 + Math.sin(frame/30)*50; ctx.strokeStyle="#5d4037"; ctx.lineWidth=3; ctx.beginPath(); ctx.moveTo(300, 0); ctx.lineTo(swingX, 200); ctx.stroke(); ctx.beginPath(); ctx.moveTo(320, 0); ctx.lineTo(swingX+20, 200); ctx.stroke(); ctx.fillStyle="#8e44ad"; ctx.fillRect(swingX-10, 200, 40, 10);
                    drawWelcomeSign(300, 150, currentCity.name); drawMale(swingX-15, 200, 1.5); drawFemale(swingX+15, 200, 1.5);
                } else if (currentCity.type==="icecream") {
                     ctx.fillStyle="#d35400"; ctx.beginPath(); ctx.moveTo(400, 350); ctx.lineTo(350, 150); ctx.lineTo(450, 150); ctx.fill(); ctx.fillStyle="#fff"; ctx.beginPath(); ctx.arc(400, 150, 60, 0, Math.PI, true); ctx.fill(); drawText("MITCHELL'S", 400, 100, 20, "center", "#333");
                     drawWelcomeSign(300, 200, currentCity.name);
                     obstacles.forEach(o => drawObstacle(o));
                     let charX = 50 + (travelProgress/200)*500; drawMale(charX, 280+jumpY, 1.5); drawFemale(charX+25, 280+jumpY, 1.5);
                } else if (currentCity.type==="bottleworks") {
                     ctx.fillStyle="#a93226"; ctx.fillRect(100, 100, 400, 300); ctx.fillStyle="#f1c40f"; ctx.fillRect(120, 120, 30, 80); ctx.fillRect(450, 120, 30, 80); drawText("BOTTLEWORKS HOTEL", 300, 40, 20, "center", "#f1c40f");
                     drawWelcomeSign(300, 150, currentCity.name); // Raised
                     
                     // Stationary Car (Drawn after building, before characters)
                     let carX = 400;
                     ctx.fillStyle="#3498db"; ctx.fillRect(carX, 320, 60, 30); // Body
                     ctx.fillStyle="#2c3e50"; ctx.fillRect(carX+10, 305, 40, 15); // Top
                     ctx.fillStyle="#333"; ctx.beginPath(); ctx.arc(carX+15, 350, 10, 0, Math.PI*2); ctx.fill(); // Wheel 1
                     ctx.beginPath(); ctx.arc(carX+45, 350, 10, 0, Math.PI*2); ctx.fill(); // Wheel 2

                     drawMale(sceneCharX, 280+jumpY, 1.5); drawFemale(sceneCharX+25, 280+jumpY, 1.5);
                     drawSpeechBubble("Oooh they took their parking spot!", sceneCharX + 30, 280);
                } else if (currentCity.type==="dunes") {
                     ctx.fillStyle=palette.sand; ctx.beginPath(); ctx.moveTo(0, 400); for(let i=0; i<=600; i+=10) { ctx.lineTo(i, 300 + Math.sin(i/50)*50); } ctx.lineTo(600, 400); ctx.fill();
                     drawWelcomeSign(300, 200, currentCity.name);
                     let charX = 50 + (travelProgress/200)*500; 
                     let charY = 270 + Math.sin(charX/50)*50; // Moving on dunes
                     drawMale(charX, charY+jumpY, 1.5); drawFemale(charX+30, charY+jumpY, 1.5);
                } else if (currentCity.type==="pinkhouse") {
                     ctx.fillStyle=palette.pinkHouse; ctx.fillRect(150, 100, 300, 250); ctx.fillStyle="#fff"; ctx.fillRect(180, 100, 20, 250); ctx.fillRect(400, 100, 20, 250); drawText("THE PINK HOUSE", 300, 90, 20, "center", "#fff");
                     drawWelcomeSign(300, 200, currentCity.name);
                     let charX = 50 + (travelProgress/200)*500; // Dynamic movement
                     drawMale(charX, 280+jumpY, 1.5); drawFemale(charX+25, 280+jumpY, 1.5);
                     drawSpeechBubble("Is that a mirage?", charX, 250);
                     drawSpeechBubble("We've been walking forever!", charX + 30, 220);
                } else if (currentCity.type==="neon") {
                     // Nashville - REDESIGN: Neon Bar Row
                     ctx.fillStyle="#050505"; ctx.fillRect(0,0,600,400);
                     const barColors = ["#e91e63", "#00e5ff", "#fdd835"];
                     for(let i=0; i<3; i++) {
                         let bx = 50 + i*180; let flash=(frame%20<10);
                         ctx.strokeStyle = flash ? barColors[i] : "#333"; ctx.lineWidth = 4; ctx.strokeRect(bx, 100, 160, 300);
                         ctx.fillStyle=flash ? barColors[i]+"40" : "#111"; ctx.fillRect(bx, 100, 160, 300);
                         ctx.fillStyle=flash ? "#fff" : "#555"; ctx.fillRect(bx+20, 150, 40, 60); ctx.fillRect(bx+100, 150, 40, 60);
                         drawText(i===0?"TOOTSIE'S":i===1?"THE STAGE":"LEGENDS", bx+80, 265, 12, "center", ctx.strokeStyle);
                     }
                     // Flashing Neon Guitar - NEW
                     let neonCol = (frame%20<10) ? palette.neonPink : palette.neonBlue;
                     let neonCol2 = (frame%20<10) ? palette.neonBlue : palette.neonPink;
                     ctx.lineWidth = 5;
                     
                     // Outer glow
                     ctx.strokeStyle = neonCol + "40";
                     ctx.beginPath();
                     ctx.moveTo(500, 40); ctx.lineTo(500, 150);
                     ctx.bezierCurveTo(450, 180, 450, 250, 500, 280);
                     ctx.bezierCurveTo(550, 250, 550, 180, 500, 150);
                     ctx.stroke();

                     // Inner tube
                     ctx.strokeStyle = neonCol;
                     ctx.lineWidth = 3;
                     ctx.beginPath();
                     ctx.moveTo(500, 40); ctx.lineTo(500, 150);
                     ctx.bezierCurveTo(450, 180, 450, 250, 500, 280);
                     ctx.bezierCurveTo(550, 250, 550, 180, 500, 150);
                     ctx.stroke();

                     // Strings and details
                     ctx.strokeStyle = neonCol2;
                     ctx.lineWidth = 1;
                     ctx.beginPath(); ctx.moveTo(495, 40); ctx.lineTo(495, 280); ctx.stroke();
                     ctx.beginPath(); ctx.moveTo(505, 40); ctx.lineTo(505, 280); ctx.stroke();
                     
                     drawText("MUSIC CITY", 500, 120, 10, "center", neonCol);

                     drawWelcomeSign(300, 150, currentCity.name);
                     let charX = 50 + (travelProgress/200)*500; 
                     drawMale(charX, 280+jumpY, 1.5); drawFemale(charX+25, 280+jumpY, 1.5);
                     drawSpeechBubble("Best tater tots I've ever had!", charX, 280);
                } else if (currentCity.type==="swamp") {
                     ctx.fillStyle=palette.swampWater; ctx.fillRect(0, 300, 600, 100);
                     ctx.fillStyle="#bdc3c7"; ctx.beginPath(); ctx.moveTo(100, 310); ctx.lineTo(150, 310); ctx.lineTo(180, 280); ctx.lineTo(50, 280); ctx.fill();
                     ctx.strokeStyle="#555"; ctx.lineWidth=2; ctx.beginPath(); ctx.arc(70, 260, 30, 0, Math.PI*2); ctx.stroke(); ctx.beginPath(); ctx.moveTo(70, 230); ctx.lineTo(70, 290); ctx.stroke(); ctx.beginPath(); ctx.moveTo(40, 260); ctx.lineTo(100, 260); ctx.stroke();
                     obstacles.forEach(o => drawObstacle(o));
                     let charX = 50 + (travelProgress/200)*500;
                     // FIX: DRAW GATORS HERE (AFTER BG)
                     drawMale(charX, 260+jumpY, 1.5); drawFemale(charX+25, 260+jumpY, 1.5);
                     drawWelcomeSign(300, 200, currentCity.name);
                } else if (currentCity.type==="bourbon") {
                     const barColors = ["#e74c3c", "#f39c12", "#8e44ad", "#2980b9"];
                     for(let i=0; i<4; i++) { let x=i*150; ctx.fillStyle=barColors[i%4]; ctx.fillRect(x, 100, 150, 300); ctx.fillStyle="#1a1a1a"; ctx.fillRect(x+20, 130, 40, 60); ctx.fillRect(x+90, 130, 40, 60); ctx.strokeStyle=(i%2==0)?"#f1c40f":"#e74c3c"; ctx.lineWidth=2; ctx.strokeRect(x+30, 220, 90, 30); let signText=(i%2==0)?"BAR":"JAZZ"; drawText(signText, x+75, 245, 10, "center", (i%2==0)?"#f1c40f":"#e74c3c"); }
                     ctx.fillStyle="#1e8449"; ctx.fillRect(230, 50, 140, 40); ctx.strokeStyle="#fff"; ctx.lineWidth=2; ctx.strokeRect(230, 50, 140, 40); drawText("Bourbon St", 300, 78, 12, "center", "white");
                     drawWelcomeSign(300, 200, currentCity.name);
                     // Fix: Allow movement in New Orleans
                     let charX = 50 + (travelProgress/200)*500; 
                     drawMale(charX, 280+jumpY, 1.5); drawFemale(charX+25, 280+jumpY, 1.5);
                     drawSpeechBubble("Am I on the train tracks?!?!", charX, 280);
                }
                
                drawText("Hold Right >", 500, 380, 12, "center");
                break;
            case STATES.PREGNANCY_TEST:
                ctx.fillStyle="#fff"; ctx.fillRect(0,0,600,400); drawText("TRYING FOR FAMILY", 300, 80, 25, "center", "#333");
                drawMale(200, 200, 2); drawFemale(400, 200, 2);
                if(testResultState==="waiting") drawText("Press Enter to test", 300, 320, 15, "center", "#555");
                else if(testResultState==="checking") drawText("Checking...", 300, 320, 15, "center", "#555");
                else if(testResultState==="negative") drawText("Negative...", 300, 320, 25, "center", "#e74c3c");
                else if(testResultState==="positive") { drawText("PREGNANT!", 300, 150, 40, "center", "#27ae60"); drawPixelHeart(300, 280, 5); }
                break;
            case STATES.CHRISTMAS:
                ctx.fillStyle="#145a32"; ctx.fillRect(0,0,600,400);
                christmasSparkle.forEach(s=>{ctx.fillStyle=s.color; ctx.fillRect(s.x, s.y, 2, 2); s.y+=s.speed; if(s.y>400)s.y=0;});
                ctx.fillStyle="#27ae60"; ctx.beginPath(); ctx.moveTo(300, 100); ctx.lineTo(200, 300); ctx.lineTo(400, 300); ctx.fill();
                ctx.fillStyle="#fff"; for(let i=0; i<15; i++) ctx.fillRect(50+i*35, 320, 10, 20);
                drawMale(250, 310, 2); drawFemale(350, 310, 2); drawText("CHRISTMAS ANNOUNCEMENT", 300, 60, 20, "center", "gold");
                if(frame%60<40) drawText("WE'RE HAVING A BABY!", 300, 200, 22, "center", "#fff");
                break;
            case STATES.BIRTH:
                ctx.fillStyle="#ecf0f1"; ctx.fillRect(0,0,600,400); drawText("WELCOME TO THE WORLD", 300, 80, 20, "center", "#333");
                drawMale(180, 250, 2.5); drawFemale(420, 250, 2.5); drawBaby(300, 280, 3);
                drawText("AUGUST 13, 2025", 300, 350, 30, "center", "#2980b9"); drawText("Press Right >", 300, 390, 10, "center", "#333");
                break;
            case STATES.PARENTING_CHAOS:
                ctx.fillStyle="#95a5a6"; ctx.fillRect(0,0,600,400);
                for(let i=0; i<10; i++) { ctx.fillStyle="white"; let dx=(i*70+30)%550; let dy=300+(i%2)*30; ctx.fillRect(dx, dy, 15, 10); }
                // Draw Obstacles AFTER BG
                obstacles.forEach(o => drawObstacle(o));
                drawMale(sceneCharX, 280+jumpY, 2.5); drawFemale(sceneCharX+30, 280+jumpY, 2.5);
                let babyY=280+(frame%10<5?-2:2); drawBaby(500, babyY, 1.5, null, true); // Baby Size 1.5 (Smaller)
                drawText("WAAH!", 500, 250, 15, "center", "red"); drawText("Hold Right >", 500, 380, 12, "center");
                break;
            case STATES.JEWELRY_STORE:
                ctx.fillStyle="#ecf0f1"; ctx.fillRect(0,0,600,400);
                ctx.fillStyle="#2c3e50"; ctx.fillRect(50, 50, 500, 250); ctx.fillStyle="#f39c12"; ctx.fillRect(100, 100, 400, 50); drawText("JEWELRY STORE", 300, 135, 20, "center", "white");
                drawMale(300, 330, 2.5);
                if(jewelryState==="browsing") {
                    drawText("Pick a Ring:", 300, 60, 15, "center", "#333");
                    let ringCols=["purple","red","green"];
                    for(let i=0;i<3;i++) {
                        let x=150+i*150; ctx.strokeStyle=(ringIndex===i)?"gold":"#555"; ctx.lineWidth=3; ctx.beginPath(); ctx.arc(x, 200, 20, 0, Math.PI*2); ctx.stroke();
                        ctx.fillStyle=ringCols[i]; ctx.fillRect(x-5, 175, 10, 10); if(i===2) { ctx.fillStyle="cyan"; ctx.fillRect(x-2, 178, 4, 4); }
                    }
                } else drawText("NO!", 300, 200, 30, "center", "red");
                break;
            case STATES.HALLOWEEN:
                ctx.fillStyle="#2c3e50"; ctx.fillRect(0,0,600,400); // BG
                ctx.fillStyle="#f1c40f"; ctx.beginPath(); ctx.arc(500, 80, 40, 0, Math.PI*2); ctx.fill();
                // Ghosts/Bats...
                 ctx.fillStyle = "rgba(255, 255, 255, 0.7)"; for(let i=0; i<3; i++) { let gx = 100 + i*150; let gy = 150 + Math.sin(frame/20 + i)*20; ctx.beginPath(); ctx.arc(gx, gy, 20, Math.PI, 0); ctx.fillRect(gx-20, gy, 40, 30); ctx.fill(); ctx.fillStyle = "black"; ctx.fillRect(gx-10, gy-5, 5, 5); ctx.fillRect(gx+5, gy-5, 5, 5); ctx.fillStyle = "rgba(255, 255, 255, 0.7)"; }
                obstacles.forEach(o => drawObstacle(o));
                drawMale(sceneCharX, 280+jumpY, 2.5); drawFemale(sceneCharX+30, 280+jumpY, 2.5); drawBaby(sceneCharX+60, 280+jumpY, 1.5, "cowboy"); // Baby Size 1.5
                drawText("Hold Right >", 500, 380, 12, "center");
                break;
            case STATES.MAKING_MONTAGE:
                ctx.fillStyle="#333"; ctx.fillRect(0,0,600,400); drawText("MAKING PROPOSAL MONTAGE", 300, 60, 20, "center", "white");
                ctx.fillStyle="#7f8c8d"; ctx.fillRect(250, 250, 100, 80); ctx.fillStyle="#bdc3c7"; ctx.fillRect(270, 200, 60, 50);
                drawMale(240, 250, 2.5, false, true); // Side profile
                drawSpeechBubble("I hate this f**king computer!", 300, 150); drawText("Press Right >", 300, 380, 12, "center");
                break;
            case STATES.THANKSGIVING:
                ctx.fillStyle="#8d6e63"; ctx.fillRect(0,0,600,400); drawText("FIRST FAMILY THANKSGIVING", 300, 60, 20, "center", "white");
                ctx.fillStyle="#5d4037"; ctx.fillRect(150, 300, 300, 100); ctx.fillStyle="#e67e22"; ctx.beginPath(); ctx.arc(300, 280, 30, Math.PI, 0); ctx.fill(); ctx.fillRect(280, 280, 10, 20); ctx.fillRect(310, 280, 10, 20);
                obstacles.forEach(o => drawObstacle(o));
                drawMale(sceneCharX, 280+jumpY, 2.5); drawFemale(sceneCharX+30, 280+jumpY, 2.5); drawBaby(sceneCharX+60, 300+jumpY, 1.5); // Baby Size 1.5
                drawText("Hold Right >", 500, 380, 12, "center");
                break;
            case STATES.THEATER_OUTSIDE:
                ctx.fillStyle="#1a1a1a"; ctx.fillRect(0,0,600,400); ctx.fillStyle=palette.theaterRed; ctx.fillRect(100, 50, 400, 100);
                for(let i=0;i<20;i++) { ctx.fillStyle=(frame%30<15)?"yellow":"orange"; ctx.fillRect(110+i*19, 55, 10, 10); ctx.fillRect(110+i*19, 135, 10, 10); }
                ctx.fillStyle="white"; ctx.fillRect(120, 70, 360, 60); drawText("LITTLE ART THEATRE", 300, 110, 20, "center", "black");
                drawMale(250, 300, 2); drawFemale(350, 300, 2);
                break;
            case STATES.THEATER_INSIDE:
                ctx.fillStyle="#000"; ctx.fillRect(0,0,600,400); ctx.fillStyle="#ccc"; ctx.fillRect(150, 20, 300, 120);
                ctx.fillStyle="#c0392b"; ctx.beginPath(); ctx.moveTo(250, 250); ctx.lineTo(350, 250); ctx.lineTo(400, 400); ctx.lineTo(200, 400); ctx.fill();
                ctx.fillStyle="#222"; ctx.fillRect(0, 350, 200, 50); ctx.fillRect(400, 350, 200, 50);
                if(!celebrationActive) {
                    drawMale(200, 280, 2.5, true); drawFemale(400, 280, 2.5);
                    ctx.fillStyle="white"; ctx.strokeStyle="black"; ctx.lineWidth=4; ctx.strokeRect(100, 50, 400, 70); ctx.fillRect(100, 50, 400, 70);
                    drawText("Will you marry me?", 300, 75, 15, "center", "black");
                    drawText("YES", 250, 100, 20, "center", proposalChoice===1?palette.krogerBlue:"#bdc3c7");
                    drawText("NO", 350, 100, 20, "center", proposalChoice===0?palette.krogerBlue:"#bdc3c7");
                    drawText(">", proposalChoice===1?200:390, 100, 20, "center", palette.krogerBlue);
                } else {
                    celebrationTimer++; drawMale(200, 280, 2.5, true); drawFemale(400, 280, 2.5);
                    confetti.forEach(c=>{ctx.fillStyle=c.color; ctx.fillRect(c.x, c.y, 4, 4); c.y+=c.speed;});
                    balloons.forEach(b=>{ctx.fillStyle=b.color; ctx.beginPath(); ctx.arc(b.x, b.y, 10, 0, Math.PI*2); ctx.fill(); b.y-=b.speed;});
                    drawText("SHE SAID YES!", 300, 200, 40, "center", "#e91e63");
                    if(celebrationTimer>200) { currentState=STATES.FUTURE_HOME; celebrationActive=false; celebrationTimer=0; }
                }
                break;
            case STATES.FUTURE_HOME:
                ctx.fillStyle="#87ceeb"; ctx.fillRect(0,0,600,400); ctx.fillStyle="#2ecc71"; ctx.fillRect(0, 300, 600, 100);
                ctx.fillStyle="#fdfefe"; ctx.fillRect(200, 200, 200, 150); ctx.fillStyle="#a93226"; ctx.beginPath(); ctx.moveTo(180, 200); ctx.lineTo(300, 100); ctx.lineTo(420, 200); ctx.fill();
                ctx.fillStyle="#5d4037"; ctx.fillRect(280, 280, 40, 70); ctx.fillStyle="#87ceeb"; ctx.fillRect(220, 230, 40, 40); ctx.fillRect(340, 230, 40, 40);
                ctx.fillStyle="#555"; ctx.fillRect(450, 300, 5, 50); ctx.fillStyle="#fff"; ctx.fillRect(440, 290, 30, 15); drawText("The DelBeckers", 450, 280, 8, "center", "#000");
                drawText("LEVEL UNLOCKED:", 300, 50, 20, "center", "#000"); drawText("Our Next Chapter?", 300, 80, 20, "center", "#000"); drawText("Press Right >", 300, 380, 10, "center", "#333");
                break;
            case STATES.FINAL_HINT:
                ctx.fillStyle="#000"; ctx.fillRect(0,0,600,400); drawText("TO BE CONTINUED...", 300, 180, 25, "center", "white");
                drawText("Get ready for the", 300, 230, 15, "center", "#aaa"); drawText("next great adventure", 300, 260, 15, "center", "#aaa");
                break;
        }
        
        // HUD
        const hideHudStates = [ STATES.START, STATES.TINDER, STATES.MATCHED, STATES.DATING_TACOS, STATES.DATING_PUB, STATES.DATING_YELLOW ];
        if (!hideHudStates.includes(currentState)) {
             drawText("MB", 20, 30, 15, "left", "#fff"); drawPixelHeart(60, 18, 3); drawText("VD", 80, 30, 15, "left", "#fff"); 
        }
        if (screenShake > 0) ctx.restore();
        requestAnimationFrame(gameLoop);
    }
    requestAnimationFrame(gameLoop);
</script>
</body>
</html>
